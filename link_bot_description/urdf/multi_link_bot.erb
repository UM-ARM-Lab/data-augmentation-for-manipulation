<%link_length = @length/@num_links - @radius/2%>
<%collision_link_length = link_length - @radius%>
<%link_mass = @mass/@num_links%>
<?xml version="1.0"?>
<robot name="link_bot">
    <% for i in 1..@num_links %>
    <link name="link_<%=i%>">
        <visual>
            <origin rpy="0 -1.5707 0" xyz="<%=link_length / 2.0 - @radius / 2.0%> 0 0"/>
            <geometry>
                <cylinder length="<%= link_length%>" radius="<%= @radius%>"/>
            </geometry>
        </visual>
        <collision name="link_<%= i %>_collision">
            <origin rpy="0 -1.5707 0" xyz="<%= link_length / 2.0 - @radius / 2.0%> 0 0"/>
            <geometry>
                <box size="<%= @radius*2 %> <%= @radius*2 %> <%= collision_link_length %>"/>
            </geometry>
            <surface>
              <friction>
                <ode>
                  <mu>1</mu>
                  <mu2>1</mu2>
                </ode>
              </friction>
            </surface>
        </collision>
        <inertial>
            <mass value="<%= link_mass %>"/>
            <inertia
              ixx="<%=1.0/12.0*link_mass*(8*@radius*@radius)%>"
              ixy="0"
              ixz="0"
              iyy="<%=1.0/12.0*link_mass*((link_length-@radius/2)*(link_length-@radius/2)+4*@radius*@radius)%>"
              iyz="0"
              izz="<%=1.0/12.0*link_mass*((link_length-@radius/2)*(link_length-@radius/2)+4*@radius*@radius)%>"/>
            <origin rpy="0 0 0" xyz="<%=link_length/2 - @radius/2%> 0 0"/>
        </inertial>
    </link>
    <% end %>

    <link name="head">
        <visual>
            <origin rpy="0 0 0" xyz="0 0 0"/>
            <geometry>
                <sphere radius="<%= @radius %>"/>
            </geometry>
        </visual>
        <collision name="head">
            <origin rpy="0 0 0" xyz="0 0 0"/>
            <geometry>
                <sphere radius="<%= @radius %>" />
            </geometry>
            <surface>
              <friction>
                <ode>
                  <mu>1</mu>
                  <mu2>1</mu2>
                </ode>
              </friction>
            </surface>
        </collision>
        <inertial>
            <mass value="0.1"/>
            <origin rpy="0 0 0" xyz="0 0 0"/>
            <inertia ixx="0.0001" ixy="0" ixz="0" iyy="0.0001" iyz="0" izz="0.001"/>
        </inertial>
    </link>

    <% for i in 1..@num_links-1 %>
    <joint name="joint_<%=i%>" type="revolute">
        <parent link="link_<%=i%>"/>
        <child link="link_<%=i+1%>"/>
        <origin xyz="<%=link_length - @radius/2.0%> 0 0"/>
        <axis xyz="0 0 1"/>
        <limit lower="-3" upper="3" effort="10" velocity="5"/>
        <dynamics damping="1.0" friction="0.0"/>
    </joint>
    <% end %>

    <joint name="head_joint" type="revolute">
        <parent link="link_<%=@num_links%>"/>
        <child link="head"/>
        <origin xyz="<%=link_length - @radius/2.0%> 0 0"/>
        <axis xyz="0 0 1"/>
        <limit lower="-3" upper="3" effort="10" velocity="5"/>
        <dynamics damping="1.0" friction="0.0"/>
    </joint>

    <% for i in 1..@num_links %>
    <gazebo reference="link_<%=i%>">
        <material>Gazebo/Green</material>
        <self_collide>true</self_collide>
        <sensor name='link_<%=i%>_contact' type='contact'>
            <contact>
                <collision>link_<%=i%>_collision</collision>
            </contact>
        </sensor>
    </gazebo>
    <% end %>

    <gazebo reference="head">
        <self_collide>true</self_collide>
        <material>Gazebo/Blue</material>
        <sensor name='head_contact' type='contact'>
            <contact>
                <collision>head_collision</collision>
            </contact>
        </sensor>
    </gazebo>

    <gazebo reference="head_joint">
    </gazebo>

    <gazebo>
        <plugin name="multi_link_bot_model_plugin" filename="libmulti_link_bot_model_plugin.so">
            <%= @multi_link_bot_model_plugin_args %>
        </plugin>
    </gazebo>
</robot>
